generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Tables

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  families             FamilyMember[]
  createdTransactions  Transaction[]  @relation("CreatedBy")
  assignedTransactions Transaction[]  @relation("AssignedTo")
}

model Family {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members      FamilyMember[]
  bankAccounts BankAccount[]
  categories   Category[]
  transactions Transaction[]
}

model FamilyMember {
  id        String   @id @default(uuid())
  role      String   @default("member") // Ex: "admin", "member"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User   @relation(fields: [userId], references: [id])
  userId   String
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  familyId String

  @@unique([userId, familyId])
}

model BankAccount {
  id                String   @id @default(uuid())
  name              String
  bank              String // Ex: "Itaú", "Nubank"
  initialBalance    Float
  hasCreditCard     Boolean  @default(false)
  invoiceClosingDay Int? // Dia do fechamento da fatura (1-28)
  invoiceDueDay     Int? // Dia do vencimento da fatura (1-28)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  family       Family        @relation(fields: [familyId], references: [id])
  familyId     String
  creditCards  CreditCard[]
  transactions Transaction[]
}

model CreditCard {
  id        String   @id @default(uuid())
  nickname  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bankAccount   BankAccount @relation(fields: [bankAccountId], references: [id])
  bankAccountId String

  transactions Transaction[]
}

model Category {
  id   String @id @default(uuid())
  name String
  type String // "income" ou "expense"

  color String // "#FF0000" (Hex) ou "blue" (Tag do Antd)
  icon  String // "home", "car", "shopping" (Identificador do ícone)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  familyId String

  transactions Transaction[]

  @@unique([familyId, name, type])
}

model Transaction {
  id          String   @id @default(uuid())
  description String
  amount      Float
  date        DateTime
  type        String // "income" ou "expense"
  isPaid      Boolean  @default(false)

  // Detalhes do pagamento (preenchido quando isPaid = true)
  paymentMethod String? // "debit", "credit"
  paidAt        DateTime?

  // Recorrência e Parcelamento
  recurrenceGroupId        String? // UUID para agrupar transações recorrentes/parceladas
  isRecurrent              Boolean? @default(false)
  recurrenceType           String? // "days", "weeks", "months", "years"
  recurrenceInterval       Int?
  isInstallment            Boolean? @default(false)
  installmentsTotal        Int?
  installmentCurrentNumber Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacionamentos
  family        Family       @relation(fields: [familyId], references: [id])
  familyId      String
  category      Category     @relation(fields: [categoryId], references: [id])
  categoryId    String
  bankAccount   BankAccount? @relation(fields: [bankAccountId], references: [id])
  bankAccountId String?
  creditCard    CreditCard?  @relation(fields: [creditCardId], references: [id])
  creditCardId  String?

  assignedTo   User?   @relation("AssignedTo", fields: [assignedToId], references: [id])
  assignedToId String? // Quem "fez" a transação (opcional)

  createdBy   User   @relation("CreatedBy", fields: [createdById], references: [id])
  createdById String // Quem registrou no sistema
}
